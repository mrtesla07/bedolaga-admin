<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <title>Действия web API — Bedolaga Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="{{ url_for('static', path='admin.css') }}">
</head>
<body>
    <div class="page">
        <header class="page__header">
            <div class="page__breadcrumbs">
                <a class="page__back" href="/admin/">
                    <span aria-hidden="true">←</span>
                    <span>Вернуться в SQLAdmin</span>
                </a>
                <div class="badges">
                    {% set api_badge = "badge--positive" if api_configured else "badge--warning" %}
                    {% set api_text = "Web API подключено" if api_configured else "Web API не настроено" %}
                    <span class="badge {{ api_badge }}">{{ api_text }}</span>
                    <span class="badge badge--muted">CSRF активен</span>
                    <span class="badge badge--muted">Лимит: {{ security_settings.rate_limit_count }} / {{ security_settings.rate_limit_period_seconds }} с</span>
                </div>
            </div>

            <div class="brand">
                <img src="{{ url_for('static', path='bedolaga-logo.svg') }}" alt="Логотип Bedolaga" class="brand__logo">
                <div class="brand__text">
                    <h1 class="brand__title">Центр действий Bedolaga</h1>
                    <p class="brand__subtitle">
                        Управляйте подписками, балансом и доступом через web API. Проверьте параметры, подтвердите действие — всё остальное задокументируем сами.
                    </p>
                    <ul class="brand__meta">
                        <li>Администратор: {{ admin.full_name or admin.email }}</li>
                        <li>
                            Роли:
                            {% if admin.roles %}
                                {{ admin.roles | map(attribute='name') | join(', ') }}
                            {% else %}
                                не назначены
                            {% endif %}
                        </li>
                    </ul>
                </div>
            </div>
        </header>

        {% if result %}
        <section class="card card--result card--{{ result.status }}">
            <h2 class="card__title">{{ result.title }}</h2>
            <p class="card__text">{{ result.message }}</p>
        </section>
        {% endif %}

        <main class="page__content">
            {% for action in actions %}
            {% set permitted = allowed_actions.get(action.key, False) %}
            {% set values = form_values.get(action.key, {}) %}
            {% set field_count = action.get('fields', []) | length %}
            <section class="card action-card {% if submitted_action == action.key %}action-card--active{% endif %}">
                <header class="action-card__header">
                    <h2 class="action-card__title">{{ action.title }}</h2>
                    <p class="action-card__description">{{ action.description }}</p>
                    <div class="action-card__meta">
                        <span class="badge {{ 'badge--positive' if permitted else 'badge--warning' }}">
                            {% if permitted %}Доступно{% else %}Нет прав{% endif %}
                        </span>
                        {% if not api_configured %}
                        <span class="badge badge--warning">Web API выключено</span>
                        {% endif %}
                        {% if action.permission %}
                        <span class="badge badge--muted">perm: {{ action.permission }}</span>
                        {% endif %}
                    </div>
                </header>

                <form method="post" class="action-card__form">
                    <input type="hidden" name="action" value="{{ action.key }}">
                    <input type="hidden" name="_csrf_token" value="{{ csrf_token }}">
                    <div class="form-grid {% if field_count > 1 %}columns-2{% endif %}">
                        {% for field in action.get('fields', []) %}
                            {% set default_value = field.get('default', '') %}
                            {% set value = values.get(field.name, default_value) %}
                            {% if field.type == 'checkbox' %}
                                {% set checked = value in ['on', 'true', '1', 1, True] %}
                                <div class="field checkbox">
                                    <label>
                                        <input type="checkbox" name="{{ field.name }}" value="on" {% if checked %}checked{% endif %} {% if not api_configured or not permitted %}disabled{% endif %}>
                                        <span>{{ field.label }}</span>
                                    </label>
                                </div>
                            {% elif field.type == 'textarea' %}
                                <div class="field">
                                    <label>
                                        <span>{{ field.label }}</span>
                                        <textarea
                                            name="{{ field.name }}"
                                            {% if field.get('rows') %}rows="{{ field.get('rows') }}"{% endif %}
                                            {% if field.get('required') %}required{% endif %}
                                            {% if field.get('placeholder') %}placeholder="{{ field.get('placeholder') }}"{% endif %}
                                            {% if not api_configured or not permitted %}disabled{% endif %}
                                        >{{ value }}</textarea>
                                    </label>
                                </div>
                            {% elif field.type == 'select' %}
                                <div class="field">
                                    <label>
                                        <span>{{ field.label }}</span>
                                        <select
                                            name="{{ field.name }}"
                                            {% if field.get('required') %}required{% endif %}
                                            {% if not api_configured or not permitted %}disabled{% endif %}
                                        >
                                            {% for option in field.options %}
                                            <option value="{{ option.value }}" {% if value == option.value %}selected{% endif %}>{{ option.label }}</option>
                                            {% endfor %}
                                        </select>
                                    </label>
                                </div>
                            {% else %}
                                <div class="field">
                                    <label>
                                        <span>{{ field.label }}</span>
                                        <input
                                            type="{{ field.type }}"
                                            name="{{ field.name }}"
                                            value="{{ value }}"
                                            {% if field.get('required') %}required{% endif %}
                                            {% if field.get('placeholder') %}placeholder="{{ field.get('placeholder') }}"{% endif %}
                                            {% if field.get('min') is not none %}min="{{ field.get('min') }}"{% endif %}
                                            {% if field.get('step') %}step="{{ field.get('step') }}"{% endif %}
                                            {% if not api_configured or not permitted %}disabled{% endif %}
                                        >
                                    </label>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    {% if action.key == 'recharge_balance' %}
                    <p class="note">Мягкий лимит: {{ security_settings.balance_soft_limit_rub }} ₽, жёсткий лимит: {{ security_settings.balance_hard_limit_rub }} ₽.</p>
                    <div class="field checkbox">
                        <label>
                            <input type="checkbox" name="confirm_amount" value="on" {% if values.get('confirm_amount') in ['on','true','1',1,True] %}checked{% endif %} {% if not api_configured or not permitted %}disabled{% endif %}>
                            <span>Подтверждаю сумму и цель списания</span>
                        </label>
                    </div>
                    {% elif action.key == 'block_user' %}
                    <p class="note">Действие нельзя отменить. Убедитесь, что выбрали нужного пользователя.</p>
                    <div class="field checkbox">
                        <label>
                            <input type="checkbox" name="confirm_block" value="on" {% if values.get('confirm_block') in ['on','true','1',1,True] %}checked{% endif %} {% if not api_configured or not permitted %}disabled{% endif %}>
                            <span>Да, я хочу заблокировать пользователя</span>
                        </label>
                    </div>
                    {% endif %}

                    <div class="action-card__actions">
                        <button type="submit" class="action-card__submit" {% if not api_configured or not permitted %}disabled{% endif %}>
                            {% if not api_configured %}
                                Web API недоступно
                            {% elif not permitted %}
                                Нет доступа
                            {% else %}
                                Выполнить действие
                            {% endif %}
                        </button>
                        {% if action.get('fields') %}
                        <span class="action-card__hint">Поля с пометкой обязательны для заполнения.</span>
                        {% endif %}
                    </div>
                </form>

                {% if not permitted %}
                <p class="action-card__hint">У вас нет прав на выполнение этого действия. Обратитесь к супер-администратору.</p>
                {% endif %}
            </section>
            {% endfor %}
        </main>

        <footer class="page__footer">
            Вошёл: {{ admin.full_name or admin.email }}. Каждый вызов фиксируется в журнале активности и доступен для аудита.
        </footer>
    </div>
</body>
</html>
