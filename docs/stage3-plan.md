# Этап 3 — Безопасность и роли

## Цели

- Разделить администраторов по ролям и ограничить доступ к опасным операциям.
- Вести журнал действий с ключевыми параметрами (кто, когда, какое действие, с какими данными).
- Повысить устойчивость интерфейса к случайным/повторным операциям, а также к злоупотреблениям.

## Ролевой механизм

1. **Модели**
   - Таблица `admin_roles` (`id`, `name`, `slug`, `description`, `created_at`).
   - Таблица `admin_user_roles` (FK на пользователей и роли) — многие-ко-многим.
   - Начальные роли:
     - `superadmin` — полный доступ, выдача ролей, управление токенами web API.
     - `manager` — просмотр, запуск безопасных действий (продление, баланс), но без блокировок и настройки ролей.
     - `viewer` — только просмотр SQLAdmin, без действий и настроек.
2. **Проверки**
   - В `BedolagaAuthenticationBackend.authenticate` загружать роли администратора и сохранять в `request.state.admin_roles`.
   - В SQLAdmin-представлениях переопределить `is_accessible`/`is_visible` для ограничения пунктов меню.
   - Для `/admin/actions` проверять наличие прав перед выполнением конкретного действия (например, отдельные флаги `can_extend_subscription`, `can_modify_balance`, `can_block_users`, `can_sync_remnawave`), маппя ролям разрешения.
   - Добавить CLI/миграцию и команду начального наполнения ролей.

## Аудит действий

- Таблица `admin_activity_log`:
  - поля: `id`, `admin_id`, `action`, `target_type`, `target_id`, `payload_json`, `status` (`success`/`error`), `message`, `ip_address`, `user_agent`, `created_at`.
- Сервис `audit_logger` для записи событий (при старте действия, по результатам).
- Логировать:
  - все POST/DELETE/PUT операции в `/admin/actions`;
  - смены ролей, логины/логауты (минимум успешный логин и ошибочные попытки при известных данных);
  - будущие административные операции.
- Read-only представление `AdminActivityLogAdmin` в SQLAdmin (с фильтрами по админу, типу действия, статусу).

## Дополнительная защита

1. **CSRF**
- [x] Генерация и хранение CSRF-токена (cookie + скрытое поле).
- [x] Проверка токена в POST-обработчике `/admin/actions`.
- [x] Автоматическая перевыдача токена после каждого запроса.
2. **Подтверждения и предупреждения**
   - Для действий блокировки и списания баланса добавить чекбокс «Подтверждаю последствия» или всплывающее окно.
   - Включить предупреждения, если сумма отрицательная или превышает порог (например, > 50 000 ₽).
3. **Throttling**
   - Запретить больше N действий за M секунд (например, 5 действий за минуту).
   - Реализация: in-memory (FastAPI state) + timestamp на пользователя, с возможностью подключить Redis позднее.
   - При превышении лимита — логировать событие в аудит и возвращать сообщение.
4. **Прочие меры**
   - Учитывать IP и `User-Agent` администратора при логировании.
   - Скрыть `/admin/actions`, если пользователь без ролей/прав.
   - В будущем предусмотреть MFA (оставить TODO в документации).

## Документация

- Обновить README (описать роли, инициализацию, переменные для безопасности).
- Дополнить `docs/development.md` записями о внедрённых изменениях.
- Создать инструкции по выдаче ролей / управлению правами (например, в `docs/security.md`, если потребуется).

## Приоритет внедрения

1. Модели и права доступа (роли, проверки, скрытие разделов).
2. Аудит действий и SQLAdmin-представление.
3. CSRF, подтверждения, throttling.
4. Соответствующие тесты и документация.
