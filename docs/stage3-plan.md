# Этап 3 — Безопасность и роли

## Цели

- Разделить администраторов по ролям и ограничить доступ к опасным операциям.
- Вести журнал действий с ключевыми параметрами (кто, когда, какое действие, с какими данными).
- Повысить устойчивость интерфейса к случайным/повторным операциям, а также к злоупотреблениям.

## Что сделано

- [x] Созданы таблицы `admin_roles` и `admin_user_roles`, настроены связи «многие-ко-многим».
- [x] Настроен `request.state.admin_roles` и проверки доступа в SQLAdmin-вьюхах.
- [x] На `/admin/actions` добавлена строгая проверка разрешений и понятные ошибки при нехватке прав.
- [x] Реализовано логирование действий в `admin_activity_log`, добавлен read-only `AdminActivityLogAdmin`.
- [x] CSRF-токены генерируются и валидируются для действий в админке.
- [x] Включены подтверждения критических операций (баланс, блокировки) и проверка лимитов сумм.
- [x] Добавлен in-memory throttling (rate limiter) с настройками через `AdminSecuritySettings`.

## Что осталось

- [ ] CLI/миграция для первичного наполнения ролей и выдачи прав «из коробки».
- [ ] Дополнительные проверки и напоминания перед выполнением особо опасных действий (MFA/2FA, защита от повторов).
- [ ] Более детальный аудит: логирование IP/User-Agent и ответов внешних API по ключевым маршрутам.

## Дополнительные заметки

- После закрытия оставшихся задач обновить README и `docs/development.md`.
- Подумать о выносе rate limiter в Redis, если появится несколько инстансов приложения.
- Рассмотреть создание отдельного `docs/security.md` со сводкой политик и чек-листами.
