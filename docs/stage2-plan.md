# Этап 2 — Расширение функционала

## Цели итерации

- Дать администраторам доступ к ключевым сущностям из базы бота: пользователи, подписки, транзакции.
- Поддержать удобные фильтры и поиск, быстрый переход между связанными объектами.
- Подготовить место для дальнейших интеграций с web API бота (например, продление подписки, начисление баланса).

## Сущности

### Пользователь (`users`)

- Основные поля: `telegram_id`, `username`, имя/фамилия, статус (`active`, `blocked`, `deleted`), баланс.
- Связи: `subscription` (один к одному), `transactions`, `referrer`, `promo_group`.
- Требования UI:
  - Поиск по `telegram_id`, `username`, `referral_code`, email (если появится).
  - Фильтры: статус, наличие активной подписки, признак блокировки.
  - Отображение баланса в рублях, времени последней активности, количества приглашённых.
  - Быстрые ссылки на подписку и платежи пользователя.

### Подписка (`subscriptions`)

- Основные поля: `status`, `is_trial`, `start_date`, `end_date`, `traffic_limit_gb`, `traffic_used_gb`, `autopay_enabled`.
- Связь: владелец `user`.
- Требования UI:
  - Фильтр по статусу (включая вычисляемый `actual_status`).
  - Отображение остатка времени (`time_left_display`) и прогресса трафика.
  - Быстрый переход к пользователю.
  - Возможность сортировать по дате окончания, автопродлению.

### Транзакция (`transactions`)

- Основные поля: `type` (`deposit`, `withdrawal`, `subscription_payment`, и т.д.), `amount_kopeks`, `payment_method`, `description`, `is_completed`.
- Связь: `user`.
- Требования UI:
  - Фильтр по типу операции, способу оплаты, статусу завершения.
  - Отображение суммы в рублях, времени создания/завершения.
  - Ссылка на пользователя, от которого транзакция.

## Черновые действия через web API

Задача — описать ключевые операции, которые админка должна уметь запускать через web API бота, и подготовить UI-макет:

- Продлить подписку пользователя на заданное количество дней.
- Начислить баланс (пополнить/списать) с указанием суммы и комментария.
- Заблокировать/разблокировать пользователя.
- Пересоздать доступ/ссылки (повторная синхронизация с Remnawave).

На текущей итерации реализуется только интерфейс (страница `/admin/actions`), кнопки работают как заглушки и отображают сообщение о недоступности функции. Реализация вызовов API будет добавлена на следующем этапе.

## Перекрёстные требования

- Все сущности работают с общей асинхронной сессией и таблицами бота.
- В списках желательно показать ключевые computed-поля (баланс, time_left, amount_rubles).
- Локализация интерфейса — использовать русские подписи.
- Подготовить основу для действий (кнопки) через web API (пока только описываем, реализация в следующей под-итерации).

## Документация и DX

- Обновить `docs/development.md` по ходу реализации.
- Расширить README при добавлении новых команд/зависимостей.
- Зафиксировать изменения в `docs/roadmap.md`.
