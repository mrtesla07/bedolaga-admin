# Этап 2 — Расширение функционала

## Цели итерации

- Дать администраторам доступ к ключевым сущностям из базы бота (пользователи, подписки, транзакции).
- Поддержать удобные фильтры, поиск и быстрый переход между связанными объектами.
- Обеспечить возможность запускать основные операции через web API бота прямо из админки.

## Сущности

### Пользователь (`users`)

- Основные поля: `telegram_id`, `username`, имя/фамилия, статус (`active`, `blocked`, `deleted`), баланс.
- Связи: `subscription` (один к одному), `transactions`, `referrer`, `promo_group`.
- Требования UI:
  - Поиск по `telegram_id`, `username`, `referral_code`.
  - Фильтры: статус, язык, наличие платных подписок.
  - Отображение баланса в рублях, времени последней активности, количества приглашённых.
  - Быстрые ссылки на подписку и платежи.

### Подписка (`subscriptions`)

- Основные поля: `status`, `is_trial`, `start_date`, `end_date`, `traffic_limit_gb`, `traffic_used_gb`, `autopay_enabled`.
- Связь: владелец `user`.
- Требования UI:
  - Фильтр по статусу (включая вычисляемый `actual_status`).
  - Отображение остатка времени (`time_left_display`) и прогресса трафика.
  - Быстрый переход к пользователю.
  - Возможность сортировки по дате окончания и признаку автопродления.

### Транзакция (`transactions`)

- Основные поля: `type`, `amount_kopeks`, `payment_method`, `description`, `is_completed`.
- Связь: `user`.
- Требования UI:
  - Фильтр по типу операции, способу оплаты, статусу завершения.
  - Отображение суммы в рублях, даты создания и завершения.
  - Ссылка на пользователя, к которому относится транзакция.

## Действия через web API

На странице `/admin/actions` доступны четыре интегрированных операции:

- **Продление подписки** — находит активную подписку пользователя в БД и вызывает `POST /subscriptions/{id}/extend`.
- **Начисление баланса** — отправляет `POST /users/{user_id}/balance` с суммой (в копейках), комментарием и флагом создания транзакции.
- **Обновление статуса пользователя** — переключает статус между `active` и `blocked` через `PATCH /users/{user_id}`.
- **Синхронизация с RemnaWave** — запускает одну из операций `POST /remnawave/sync/*` (выгрузка в панель, загрузка из панели, синхронизация статусов).

Форма валидирует ввод, а результаты и ошибки web API отображаются поверх списка действий.

## Перекрёстные требования

- Все сущности работают с общей асинхронной сессией и таблицами бота.
- В списках показаны вычисляемые поля (баланс, оставшееся время подписки, сумма в рублях).
- Интерфейс локализован на русский язык.
- Действия web API используют токен `X-API-Key`, задаваемый через переменные окружения.

## Документация и DX

- `docs/development.md` фиксирует ключевые изменения и решения.
- README содержит инструкции по настройке web API (`WEBAPI_BASE_URL`, `WEBAPI_API_KEY`) и запуску действий.
- `docs/roadmap.md` отражает прогресс этапа.
